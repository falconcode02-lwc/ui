<div class="form-viewer-container">
  <!-- Header -->
  <div class="form-viewer-header" *ngIf="!hideHeaderActions">
    <h2>
      <nz-icon nzType="eye" nzTheme="outline"></nz-icon>
      Form Viewer
    </h2>
    <div class="header-actions">
      <button nz-button nzType="default" (click)="loadSampleForm()" nz-tooltip nzTooltipTitle="Load Sample Form">
        <nz-icon nzType="experiment"></nz-icon>
        Sample Form
      </button>
      <button nz-button nzType="default" (click)="toggleJsonInput()" nz-tooltip nzTooltipTitle="Load from JSON">
        <nz-icon nzType="code"></nz-icon>
        Load JSON
      </button>
      <label nz-button nzType="default" for="file-upload" nz-tooltip nzTooltipTitle="Load from File">
        <nz-icon nzType="upload"></nz-icon>
        Load File
        <input id="file-upload" type="file" accept=".json" (change)="onFileSelected($event)" style="display: none" />
      </label>
      <button nz-button nzType="default" *ngIf="formSchema()" (click)="toggleSetValues()" nz-tooltip
        nzTooltipTitle="Set Form Values">
        <nz-icon nzType="edit"></nz-icon>
        Set Values
      </button>
      <button nz-button nzType="default" *ngIf="formSchema()" (click)="clearForm()" nz-tooltip
        nzTooltipTitle="Clear Form">
        <nz-icon nzType="close"></nz-icon>
        Clear
      </button>
    </div>
  </div>

  <!-- JSON Input Section -->
  <div class="json-input-section" *ngIf="isJsonInputVisible()">
    <nz-card nzTitle="Paste Form JSON">
      <textarea nz-input [(ngModel)]="jsonInput" placeholder='{"fields": [...]}' rows="10"
        style="font-family: monospace; font-size: 12px">
      </textarea>
      <div style="margin-top: 12px; text-align: right">
        <button nz-button nzType="default" (click)="toggleJsonInput()" style="margin-right: 8px">
          Cancel
        </button>
        <button nz-button nzType="primary" (click)="loadFormFromJson()">
          <nz-icon nzType="check"></nz-icon>
          Load Form
        </button>
      </div>
    </nz-card>
  </div>

  <!-- Set Values Section -->
  <div class="json-input-section" *ngIf="isSetValuesVisible()">
    <nz-card nzTitle="Set Form Values">
      <p style="
          margin-bottom: 12px;
          color: var(--text-secondary);
          font-size: 13px;
        ">
        Paste JSON object with field IDs as keys and desired values. Example:
      </p>
      <textarea nz-input [(ngModel)]="setValuesInput"
        placeholder='{"name": "John Doe", "email": "john@example.com", "country": "US"}' rows="8"
        style="font-family: monospace; font-size: 12px">
      </textarea>
      <div style="margin-top: 12px; text-align: right">
        <button nz-button nzType="default" (click)="toggleSetValues(); setValuesInput = ''" style="margin-right: 8px">
          Cancel
        </button>
        <button nz-button nzType="primary" (click)="setFormValues()">
          <nz-icon nzType="check"></nz-icon>
          Set Values
        </button>
      </div>
    </nz-card>
  </div>

  <!-- Main Content -->
  <div class="form-viewer-content">
    <nz-spin [nzSpinning]="isLoading()" nzTip="Loading form...">
      <!-- Empty State -->
      <div class="empty-state" *ngIf="!formSchema() && !isLoading()">
        <nz-icon nzType="file-search" style="font-size: 64px; opacity: 0.3"></nz-icon>
        <h3>No Form Loaded</h3>
        <p>Load a form using one of the options above to get started</p>
        <button nz-button nzType="primary" (click)="loadSampleForm()" style="margin-top: 16px">
          <nz-icon nzType="experiment"></nz-icon>
          Try Sample Form
        </button>
      </div>

      <!-- Form Display -->
      <div class="form-display" *ngIf="formSchema() && !submittedData()" [style.height]="formSchema()?.height || '100%'"
        [style.width]="formSchema()?.width || '100%'">
        <nz-card>
          <div class="form-header" *ngIf="formSchema()?.title || formSchema()?.description">
            <h2 *ngIf="formSchema()?.title" style="display: flex; align-items: center; gap: 10px">
              <ng-container *ngIf="formSchema()?.iconUrl; else fallbackIcon">
                <img [src]="formSchema()?.iconUrl || ''" alt="icon" style="
                    width: 24px;
                    height: 24px;
                    object-fit: contain;
                    border-radius: 4px;
                  " />
              </ng-container>
              <ng-template #fallbackIcon>
                <nz-icon *ngIf="formSchema()?.icon" [nzType]="formSchema()?.icon"
                  style="font-size: 22px; margin-right: 2px"></nz-icon>
              </ng-template>
              {{ formSchema()?.title }}
            </h2>
            <p *ngIf="formSchema()?.description">
              {{ formSchema()?.description }}
            </p>
          </div>

          <form [formGroup]="dynamicForm" (ngSubmit)="onSubmit()">
            <nz-tabset [nzSize]="'small'" nzType="card" (nzSelectedIndexChange)="onTabIndexChange($event)">
              @for (tab of formSection(); track tab; let i = $index) {

              <nz-tab nzClosable [nzTitle]="titleTemplate">
                <ng-template #titleTemplate>
                  <!-- <nz-icon style="color: #e19a00" /> -->
                  {{ tab.title }}
                </ng-template>
                <div style="margin-bottom: 20px;display: block;"></div>
                <div *ngFor="let field of tab.fields" class="form-field" [hidden]="!isFieldVisible(field)">
                  <!-- Field Label -->
                  <label class="field-label" *ngIf="
                      field.type !== 'button' &&
                      field.type !== 'divider' &&
                      field.label
                    ">
                    <nz-icon [nzType]="field.icon" class="field-icon"></nz-icon>
                    {{ field.label }}
                    <span class="required-mark" *ngIf="field.required">*</span>
                    <span *ngIf="hasRequiredEither(field)" style="
                        color: #888;
                        font-size: 12px;
                        font-weight: normal;
                        margin-left: 6px;
                      ">
                      (Or {{ getRequiredEitherText(field) }})
                    </span>
                    <nz-icon *ngIf="field.info" nzType="info-circle" nzTheme="outline" [nz-tooltip]="field.info" style="
                        margin-left: 6px;
                        color: var(--text-secondary);
                        cursor: help;
                        font-size: 14px;
                      ">
                    </nz-icon>
                  </label>

                  <!-- Text Input -->
                  <input *ngIf="field.type === 'text'" nz-input [formControlName]="field.id"
                    [placeholder]="field.placeholder || ''" [class.has-error]="hasError(field.id)" />
                  <div *ngIf="field.type === 'text' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Email Input -->
                  <input *ngIf="field.type === 'email'" nz-input type="email" [formControlName]="field.id"
                    [placeholder]="field.placeholder || ''" [class.has-error]="hasError(field.id)" />
                  <div *ngIf="field.type === 'email' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Password Input -->
                  <input *ngIf="field.type === 'password'" nz-input type="password" [formControlName]="field.id"
                    [placeholder]="field.placeholder || ''" [class.has-error]="hasError(field.id)" />
                  <div *ngIf="field.type === 'password' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Number Input -->
                  <input *ngIf="field.type === 'number'" nz-input type="number" [formControlName]="field.id"
                    [placeholder]="field.placeholder || ''" [min]="field.min ?? null" [max]="field.max ?? null"
                    [step]="field.step ?? 1" [class.has-error]="hasError(field.id)" />
                  <div *ngIf="field.type === 'number' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Textarea -->
                  <textarea *ngIf="field.type === 'textarea'" nz-input [formControlName]="field.id"
                    [placeholder]="field.placeholder || ''" rows="4" [class.has-error]="hasError(field.id)">
                  </textarea>
                  <div *ngIf="field.type === 'textarea' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Date Picker -->
                  <nz-date-picker *ngIf="field.type === 'date'" [formControlName]="field.id" style="width: 100%"
                    [class.has-error]="hasError(field.id)">
                  </nz-date-picker>
                  <div *ngIf="field.type === 'date' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Date Range Picker -->
                  <nz-range-picker *ngIf="field.type === 'daterange'" [formControlName]="field.id" style="width: 100%"
                    [class.has-error]="hasError(field.id)">
                  </nz-range-picker>
                  <div *ngIf="field.type === 'daterange' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Code Editor -->
                  <code-editor *ngIf="field.type === 'codeeditor'" [style.height]="'180px'" [formControlName]="field.id"
                    [theme]="options.theme" [setup]="options.setup" [disabled]="options.disabled"
                    [readonly]="options.readonly" [placeholder]="options.placeholder"
                    [indentWithTab]="options.indentWithTab" [extensions]="extensions" [indentUnit]="options.indentUnit"
                    [lineWrapping]="options.lineWrapping" [highlightWhitespace]="options.highlightWhitespace"
                    [language]="options.language" [languages]="languages" />
                  <!-- <app-editor
                *ngIf="field.type === 'codeeditor'"
                [formControlName]="field.id"
                [language]="field.language || 'javascript'"
                [theme]="'vs-dark'"
                [fontSize]="14"
                [minimap]="false"
                style="width: 100%; height: 200px; display: block; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;">
              </app-editor> -->
                  <div *ngIf="field.type === 'codeeditor' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Select Dropdown / Autocomplete -->
                  <nz-select *ngIf="field.type === 'select'" [formControlName]="field.id" style="width: 100%"
                    nzShowSearch (nzOnSearch)="onSelectSearch($event, field)"
                    [nzMode]="field.multiple ? 'multiple' : 'default'" [nzPlaceHolder]="
                      field.placeholder ||
                      (field.multiple ? 'Select options' : 'Select an option')
                    " [class.has-error]="hasError(field.id)">
                    <nz-option *ngFor="let option of $any(getFieldOptions(field))"
                      [nzValue]="$any(option).key || option" [nzLabel]="$any(option).value || option">
                    </nz-option>
                  </nz-select>
                  <div *ngIf="field.type === 'select' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Autocomplete with Add New button -->
                  <nz-select *ngIf="field.type === 'autocomplete'" [formControlName]="field.id" style="width: 100%"
                    nzShowSearch (nzOnSearch)="onSelectSearch($event, field)"
                    [nzMode]="field.multiple ? 'multiple' : 'default'"
                    [nzPlaceHolder]="field.placeholder || 'Type to search'" [nzDropdownRender]="addNewTpl"
                    [class.has-error]="hasError(field.id)">
                    <nz-option *ngFor="let option of $any(getFieldOptions(field))"
                      [nzValue]="$any(option).key || option" [nzLabel]="$any(option).value || option">
                    </nz-option>
                  </nz-select>
                  <ng-template #addNewTpl>
                    <div style="
                        padding: 8px;
                        text-align: center;
                        border-top: 1px solid var(--border-color);
                      ">
                      <nz-space [nzSize]="'small'">
                        <button *nzSpaceItem nz-button nzType="link" (click)="addNewAutocompleteOption(field)">
                          <nz-icon nzType="plus"></nz-icon>
                          Create New
                        </button>

                        <button *nzSpaceItem nz-button nzType="link" (click)="editAutocompleteOption(field)">
                          <span style="
                              width: 180px;
                              overflow: hidden;
                              text-overflow: ellipsis;
                            ">
                            <nz-icon nzType="edit"></nz-icon> Edit &nbsp;{{
                            dynamicForm.get(field.id)?.value
                            }}</span>
                        </button>
                      </nz-space>
                    </div>
                  </ng-template>
                  <div *ngIf="field.type === 'autocomplete' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Radio Group -->
                  <nz-radio-group *ngIf="field.type === 'radio'" [formControlName]="field.id" class="radio-group"
                    [class.horizontal-layout]="field.layout === 'horizontal'">
                    <label *ngFor="let option of getFieldOptions(field)" nz-radio
                      [nzValue]="$any(option).value || option">
                      {{ $any(option).value || option }}
                    </label>
                  </nz-radio-group>
                  <div *ngIf="field.type === 'radio' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Checkbox Group -->
                  <div *ngIf="field.type === 'checkbox'" [formGroupName]="field.id" class="checkbox-group"
                    [class.horizontal-layout]="field.layout === 'horizontal'">
                    <label *ngFor="let option of getFieldOptions(field)" nz-checkbox [formControlName]="
                        sanitizeKey($any(option).value || $any(option))
                      ">
                      {{ $any(option).value || option }}
                    </label>
                  </div>
                  <div *ngIf="field.type === 'checkbox' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Switch -->
                  <nz-switch *ngIf="field.type === 'switch'" [formControlName]="field.id"
                    [nzCheckedChildren]="field.checkedText || 'ON'"
                    [nzUnCheckedChildren]="field.uncheckedText || 'OFF'">
                  </nz-switch>
                  <div *ngIf="field.type === 'switch' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- File Upload -->
                  <nz-upload *ngIf="field.type === 'file'" [nzBeforeUpload]="beforeUpload.bind(this, field)"
                    [nzCustomRequest]="
                      field.uploadUrl
                        ? customUploadRequest.bind(this, field)
                        : undefined
                    " [nzShowUploadList]="field.showPreview !== false" [nzDisabled]="!isFieldEnabled(field)"
                    [nzFileList]="getFileList(field.id)" [nzListType]="
                      field.showPreview !== false ? 'picture-card' : 'text'
                    " [nzMultiple]="(field.maxFileCount || 1) > 1" [nzAccept]="getAcceptedExtensions(field)"
                    (nzChange)="handleFileChange($event, field)">
                    <div *ngIf="
                        getFileList(field.id).length < (field.maxFileCount || 1)
                      ">
                      <button nz-button [disabled]="!isFieldEnabled(field)" type="button">
                        <nz-icon nzType="upload"></nz-icon>
                        <span>{{
                          field.placeholder || "Click to Upload"
                          }}</span>
                      </button>
                    </div>
                  </nz-upload>
                  <div *ngIf="field.type === 'file'" class="field-secondary-text" style="margin-top: 8px">
                    <div *ngIf="field.secondaryText">
                      {{ field.secondaryText }}
                    </div>
                    <div style="
                        color: var(--text-secondary);
                        font-size: 11px;
                        margin-top: 4px;
                      ">
                      <span *ngIf="field.maxFileSize">Max size: {{ field.maxFileSize }}MB</span>
                      <span *ngIf="field.maxFileSize && field.maxFileCount">
                        •
                      </span>
                      <span *ngIf="field.maxFileCount">Max files: {{ field.maxFileCount }}</span>
                      <span *ngIf="
                          (field.maxFileSize || field.maxFileCount) &&
                          field.allowedExtensions &&
                          field.allowedExtensions.length > 0
                        ">
                        •
                      </span>
                      <span *ngIf="
                          field.allowedExtensions &&
                          field.allowedExtensions.length > 0
                        ">
                        Allowed: {{ field.allowedExtensions.join(", ") }}
                      </span>
                      <span *ngIf="field.uploadUrl" style="display: block; margin-top: 4px">
                        <nz-icon nzType="cloud-upload" nzTheme="outline"></nz-icon>
                        Files will be uploaded to server
                      </span>
                    </div>
                  </div>

                  <!-- Key-Value Pairs -->
                  <app-key-value-builder *ngIf="field.type === 'keyvalue'" [title]="field.label"
                    [valueControlType]="field.valueControlType || 'text'" [language]="field.language || 'javascript'"
                    [initialPairs]="getKeyValuePairs(field)" (pairsChange)="onKeyValuePairsChange(field.id, $event)">
                  </app-key-value-builder>
                  <div *ngIf="field.type === 'keyvalue' && field.secondaryText" class="field-secondary-text">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Button Component -->
                  <div *ngIf="field.type === 'button'" class="field-button-container">
                    <button nz-button nzType="primary" type="button" (click)="executeButtonAction(field)"
                      style="width: 100%">
                      <nz-icon [nzType]="field.icon || 'thunderbolt'"></nz-icon>
                      <span *ngIf="!field.hideLabel">{{ field.label }}</span>
                    </button>
                    <div *ngIf="field.secondaryText" class="field-secondary-text">
                      {{ field.secondaryText }}
                    </div>
                  </div>

                  <!-- Divider Component -->
                  <nz-divider *ngIf="field.type === 'divider'" [nzText]="field.label" [nzOrientation]="
                      field.layout === 'horizontal' ? 'center' : 'left'
                    ">
                  </nz-divider>
                  <div *ngIf="field.type === 'divider' && field.secondaryText" class="field-secondary-text"
                    style="margin-top: -12px; margin-bottom: 12px">
                    {{ field.secondaryText }}
                  </div>

                  <!-- Error Message -->
                  <div class="error-message" *ngIf="hasError(field.id)">
                    {{ getErrorMessage(field.id) }}
                  </div>
                </div>
              </nz-tab>

              }
            </nz-tabset>

            <!-- Form Actions -->
            <div class="form-actions">
              <button *ngIf="formSchema()?.showResetButton !== false" nz-button nzType="default" type="button"
                (click)="resetForm()">
                <nz-icon nzType="redo"></nz-icon>
                {{ formSchema()?.resetButtonLabel || "Reset" }}
              </button>
              <button *ngIf="formSchema()?.showSubmitButton !== false" nz-button nzType="primary" type="submit">
                <nz-icon nzType="check"></nz-icon>
                {{ formSchema()?.submitButtonLabel || "Submit" }}
              </button>
            </div>
          </form>
        </nz-card>
      </div>

      <!-- Submitted Data Display -->
      <div class="submitted-data" *ngIf="submittedData()">
        <nz-card>
          <div class="success-message">
            <nz-icon nzType="check-circle" nzTheme="fill" style="font-size: 48px; color: #52c41a"></nz-icon>
            <h2>Form Submitted Successfully!</h2>
            <p *ngIf="isPreview">Here's the data you submitted:</p>
          </div>

          <div class="data-display" *ngIf="isPreview">
            <pre>{{ submittedData() | json }}</pre>
          </div>

          <div class="form-actions" *ngIf="isPreview">
            <button nz-button nzType="default" (click)="submittedData.set(null)">
              <nz-icon nzType="edit"></nz-icon>
              Edit Form
            </button>
            <button nz-button nzType="primary" (click)="downloadSubmittedData()">
              <nz-icon nzType="download"></nz-icon>
              Download JSON
            </button>
          </div>
        </nz-card>
      </div>
    </nz-spin>
  </div>
</div>