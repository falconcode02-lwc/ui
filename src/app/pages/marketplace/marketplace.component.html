<nz-modal
    [(nzVisible)]="visible"
    nzTitle="Plugin Marketplace"
    [nzWidth]="1000"
    [nzFooter]="null"
    (nzOnCancel)="handleCancel()"
    nzCentered>
    
    <ng-container *nzModalContent>
        <!-- Search Bar -->
        <div style="margin-bottom: 16px;">
            <nz-input-group [nzPrefix]="prefixIconSearch" nzSize="large">
                <input 
                    nz-input 
                    placeholder="Search plugins by name, author, or description..." 
                    [(ngModel)]="searchTerm"
                    (keyup.enter)="onSearch()"
                    type="text" />
            </nz-input-group>
            <ng-template #prefixIconSearch>
                <nz-icon nzType="search"></nz-icon>
            </ng-template>
        </div>

        <!-- Plugin Cards Grid -->
        <nz-spin [nzSpinning]="loading" nzTip="Loading plugins...">
            <div *ngIf="plugins.length > 0" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; min-height: 400px;">
                <div *ngFor="let plugin of plugins" style="position: relative;">
                    <nz-ribbon nzText="{{plugin.isInstalled ? 'Installed' : ''}} " nzColor="#52c41a">
                        <nz-card 
                            [nzHoverable]="true"
                            [nzActions]="[actionView, actionInstall]"
                            style="height: 100%;">
                            
                            <nz-card-meta
                        [nzAvatar]="avatarTemplate"
                        [nzTitle]="titleTemplate"
                        [nzDescription]="descriptionTemplate">
                        
                        <!-- Avatar Template -->
                        <ng-template #avatarTemplate>
                            <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <img *ngIf="isExternalIcon(plugin.icon)" 
                                     [src]="plugin.icon" 
                                     style="width: 40px; height: 40px; object-fit: contain;"
                                     [alt]="plugin.pluginName"
                                     (error)="$any($event.target).style.display='none'">
                                <nz-icon *ngIf="!isExternalIcon(plugin.icon)" 
                                         [nzType]="plugin.icon || 'api'" 
                                         style="font-size: 32px; color: #666;"></nz-icon>
                            </div>
                        </ng-template>

                        <!-- Title Template -->
                        <ng-template #titleTemplate>
                            <span>{{ plugin.pluginName }}</span>
                        </ng-template>

                        <!-- Description Template -->
                        <ng-template #descriptionTemplate>
                            <div style="margin-bottom: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--text-secondary, #a8a8a8); 
                                          display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; 
                                          overflow: hidden; text-overflow: ellipsis;">
                                    {{ plugin.pluginDesc }}
                                </p>
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 12px;">
                                    <nz-tag [nzColor]="getCategoryColor(plugin.category)" *ngIf="plugin.category">
                                        {{ plugin.category }}
                                    </nz-tag>
                                    <span style="color: var(--text-tertiary, #666);">
                                        <nz-icon nzType="user"></nz-icon> {{ plugin.pluginAuthor }}
                                    </span>
                                    <span style="color: var(--text-tertiary, #666);">
                                        <nz-icon nzType="tag"></nz-icon> v{{ plugin.version }}
                                    </span>
                                    <span *ngIf="plugin.rating" style="color: var(--text-tertiary, #666);">
                                        <nz-rate [ngModel]="plugin.rating" nzDisabled [nzCount]="5" style="font-size: 12px;"></nz-rate>
                                    </span>
                                </div>
                            </div>
                        </ng-template>
                    </nz-card-meta>

                    <!-- Action Templates -->
                    <ng-template #actionView>
                        <button nz-button nzType="link" (click)="viewPluginDetails(plugin)">
                            <nz-icon nzType="eye"></nz-icon> View Details
                        </button>
                    </ng-template>

                    <ng-template #actionInstall>
                        <button 
                            nz-button 
                            nzType="link" 
                            [nzLoading]="isInstalling(plugin.pluginId)"
                            [disabled]="plugin.isInstalled || isInstalling(plugin.pluginId)"
                            (click)="installPlugin(plugin)">
                            <nz-icon *ngIf="!isInstalling(plugin.pluginId)" 
                                     [nzType]="plugin.isInstalled ? 'check-circle' : 'download'"></nz-icon>
                            {{ plugin.isInstalled ? 'Installed' : 'Install' }}
                        </button>
                    </ng-template>
                </nz-card>
                    </nz-ribbon>
                </div>
            </div>

            <!-- Empty State -->
            <nz-empty 
                *ngIf="!loading && plugins.length === 0"
                nzNotFoundContent="No plugins found"
                [nzNotFoundImage]="'simple'"
                style="margin: 40px 0;">
                <ng-template #nzNotFoundFooter>
                    <button nz-button nzType="primary" (click)="searchTerm = ''; onSearch()">
                        Clear Search
                    </button>
                </ng-template>
            </nz-empty>
        </nz-spin>

        <!-- Pagination -->
        <div *ngIf="totalElements > pageSize" style="margin-top: 16px; text-align: center;">
            <nz-pagination
                [nzPageIndex]="currentPage"
                [nzTotal]="totalElements"
                [nzPageSize]="pageSize"
                (nzPageIndexChange)="onPageChange($event)"
                nzShowSizeChanger
                [nzPageSizeOptions]="[10, 20, 50]"
                (nzPageSizeChange)="pageSize = $event; onPageChange(1)">
            </nz-pagination>
        </div>
    </ng-container>
</nz-modal>

<!-- Plugin Detail Drawer -->
<nz-drawer
    [nzVisible]="detailDrawerVisible"
    nzPlacement="right"
    [nzTitle]="detailTitle"
    [nzWidth]="600"
    [nzZIndex]="2000"
    (nzOnClose)="closePluginDetails()">
    
    <ng-template #detailTitle>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 8px; border: 1px solid #e0e0e0;">
                <img *ngIf="selectedPlugin && isExternalIcon(selectedPlugin.icon)" 
                     [src]="selectedPlugin.icon" 
                     style="width: 32px; height: 32px; object-fit: contain;"
                     [alt]="selectedPlugin.pluginName"
                     (error)="$any($event.target).style.display='none'">
                <nz-icon *ngIf="selectedPlugin && !isExternalIcon(selectedPlugin.icon)" 
                         [nzType]="selectedPlugin.icon || 'api'" 
                         style="font-size: 28px; color: #666;"></nz-icon>
            </div>
            <div>
                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary, #e8e8e8);">{{ selectedPlugin?.pluginName }}</div>
                <div style="font-size: 12px; color: var(--text-tertiary, #666);">{{ selectedPlugin?.pluginId }}</div>
            </div>
        </div>
    </ng-template>

    <ng-container *nzDrawerContent>
        <nz-spin [nzSpinning]="loadingDetails" nzTip="Loading details...">
            <div *ngIf="selectedPlugin">
                <!-- Install Button -->
                <div style="margin-bottom: 24px;">
                    <button 
                        nz-button 
                        nzType="primary" 
                        nzSize="large"
                        nzBlock
                        [nzLoading]="isInstalling(selectedPlugin.pluginId)"
                        [disabled]="selectedPlugin.isInstalled || isInstalling(selectedPlugin.pluginId)"
                        (click)="installPlugin(selectedPlugin)">
                        <nz-icon *ngIf="!isInstalling(selectedPlugin.pluginId)" 
                                 [nzType]="selectedPlugin.isInstalled ? 'check-circle' : 'download'"></nz-icon>
                        {{ selectedPlugin.isInstalled ? 'Already Installed' : 'Install Plugin' }}
                    </button>
                </div>

                <!-- Plugin Info -->
                <nz-descriptions nzBordered [nzColumn]="1" nzSize="small">
                    <nz-descriptions-item nzTitle="Plugin ID">
                        <nz-tag>{{ selectedPlugin.pluginId }}</nz-tag>
                    </nz-descriptions-item>
                    <nz-descriptions-item nzTitle="Version">
                        <nz-badge [nzText]="selectedPlugin.version" [nzStyle]="{ backgroundColor: '#52c41a' }"></nz-badge>
                    </nz-descriptions-item>
                    <nz-descriptions-item nzTitle="Author">
                        {{ selectedPlugin.pluginAuthor }}
                    </nz-descriptions-item>
                    <nz-descriptions-item nzTitle="Category" *ngIf="selectedPlugin.category">
                        <nz-tag [nzColor]="getCategoryColor(selectedPlugin.category)">
                            {{ selectedPlugin.category }}
                        </nz-tag>
                    </nz-descriptions-item>
                    <nz-descriptions-item nzTitle="Downloads" *ngIf="selectedPlugin.downloads">
                        {{ selectedPlugin.downloads | number }}
                    </nz-descriptions-item>
                    <nz-descriptions-item nzTitle="Rating" *ngIf="selectedPlugin.rating">
                        <nz-rate [ngModel]="selectedPlugin.rating" nzDisabled [nzCount]="5"></nz-rate>
                    </nz-descriptions-item>
                    <nz-descriptions-item nzTitle="Last Updated" *ngIf="selectedPlugin.lastUpdated">
                        {{ formatDate(selectedPlugin.lastUpdated) }}
                    </nz-descriptions-item>
                    <nz-descriptions-item nzTitle="Status">
                        <nz-badge 
                            [nzStatus]="selectedPlugin.isInstalled ? 'success' : 'default'" 
                            [nzText]="selectedPlugin.isInstalled ? 'Installed' : 'Not Installed'">
                        </nz-badge>
                    </nz-descriptions-item>
                </nz-descriptions>

                <!-- Description -->
                <nz-divider nzText="Description"></nz-divider>
                <div style="padding: 16px; background: var(--bg-secondary, #252525); border: 1px solid var(--border-color, #3a3a3a); border-radius: 4px; margin-bottom: 16px;">
                    <p style="margin: 0; white-space: pre-wrap; color: var(--text-primary, #e8e8e8);">{{ selectedPlugin.pluginDesc }}</p>
                </div>

                <!-- Documentation -->
                <nz-divider nzText="Documentation" *ngIf="selectedPlugin.pluginDocument"></nz-divider>
                <div *ngIf="selectedPlugin.pluginDocument" 
                     style="padding: 16px; background: var(--bg-secondary, #252525); border: 1px solid var(--border-color, #3a3a3a); border-radius: 4px; max-height: 400px; overflow-y: auto;">
                    <markdown [data]="selectedPlugin.pluginDocument"></markdown>
                </div>
            </div>
        </nz-spin>
    </ng-container>
</nz-drawer>
